- # 一、简介：[问题排查，日志难](https://docs.58corp.com/#/space/1619941563754934272)
  collapsed:: true
	- 开发一套统一规范的日志库：
	- ### 1、各模块日志 tag 不统一
	  collapsed:: true
		- 如埋点内部，埋点策略、埋点写入、上报分成多个一级 tag；RN Native、JS、Error 等同样也是多个一级 tag，无法根据 tag 快速查看单个模块的日志。需要区分出一级 tag 和二级 tag。
		- 解决：配置定义主TAG和二级TAG(按功能模块区分)。log输出时 主TAG-二级TAG
			- @UnityLogConfig(
			      className = "DemoUnityLogger",
			      primaryKey = TagAnnotation(
			          key = "UnityLogSDK",
			          des = "统一标准日志SDK"
			      ),
			      tags = arrayOf(
			          TagAnnotation(
			              key = "testModule",
			              des = "测试"
			          ),
			          TagAnnotation(
			              key = "runModules",
			              des = "执行组件"
			          )
			      )
			  )
			  class DemoUnityLogConfig {
			  
			  }
	- ### 2、关键模块日志缺失 (需要补全)
	  collapsed:: true
		- 如核心业务的执行流程、跨端/跨应用/跨模块等的通信过程、长时间运行组件的行为/状态切换、多个分支逻辑的判断等。
		- 解决：日志补全
	- ### 3、日志缺失很多关键信息
	  collapsed:: true
		- 环境信息：
			- 基础环境：系统、网络、机型
			- 日志环境：进程、线程、Activity、前后台、登陆状态、crash 时需要数据(如内存、gc...) 等
			- 关联代码：根据日志快速定位 class:method()
			- 方法入参数据
			- 排查方法：针对日志关键信息，可定制输出对应的排查方法解决方案
			- header、cookie 信息
		- 解决：
			- Log输出时，携带环境信息
	- ### 4、存在多套日志库
	  collapsed:: true
		- App、SDK、垂直业务库的 log 日志，58Flipper，线上的日志回捞各存在对应的 log 输出工具
		  线上、线下日志开关控制不统一
		- 解决：统一一套日志库，开关控制统一
	- ### 5、日志格式不统一
	  collapsed:: true
		- 日志的格式不统一
		  无法对关键核心的日志进行高亮显示 (如关键节点、空 url 等常规性异常进行提示)
		- 解决：日志SDK,统一拼装信息，和格式
	- ### 6、使用方不知道各模块日志的关键 tag
	  collapsed:: true
		- 由于未聚合日志库，无法在日志模块启动时输出所有已注册的日志业务的关键 tag 和说明
		- 解决：下边的功能一
	- ### 7、无法快速与 flipper 对接
	  collapsed:: true
		- 不规范的日志，flipper 开发各插件，如 RN、Hybrid、埋点、分享、log 等，需要各自定制去做开发，对 SDK 进行回调梳理。而规范日志后，可以通过日志格式，快速开发各种 flipper 应用插件。
	- ### 8、无法对状态变化进行主动输出
	  collapsed:: true
		- 四大组件的切换，包括 Activity(又可以区分成 Native、RN、H5)，Service...
		  Activity 的生命周期
		  路由信息
		  网络变化
		  进程变化
		- 解决：对各个信息，直接监听，统一TAG="UnityLogSmart"输出
		-
	- ### 9、无法与历史行为数据进行对比，发现异常
		- 如埋点、网络、分享的行为对比
		- 解决：
- # 二、设计
  collapsed:: true
	- ![image.png](../assets/image_1678256116856_0.png)
- # 功能一、编译期收集注解信息，获取所有的组件模块，在 UnifyLogSDK 初始化时，输出 help
  collapsed:: true
	- help:
	  collapsed:: true
		- ```
		  UnifyLog 注册的组件信息如下：
		  (你可以使用 adb logcat | grep $primaryKey 过滤出组件的所有日志，
		  使用 adb logcat | grep $primaryKey-$tag 过来出组件子模块的日志，如 xxx,
		  使用 adb logcat | grep UnifyLogSmart 过来出日志库智能提示，包括 xxx 状态变化通知)
		  
		  --------------------------------------------------------------
		  primaryKey: WubaRNSDK
		  
		  描述：RN SDK
		  
		  tag：
		    1. hotUpdate：热更新
		    2. runModules：执行组件
		    ...
		  --------------------------------------------------------------
		  primaryKey: WubaHybridSDK
		  
		  描述：Hybrid SDK
		  
		  tag：
		    1. web init：web 初始化
		    2. web preload：预加载
		    ...
		  --------------------------------------------------------------
		  ```
	- 原理见常见问题中
- # 功能二、API与输出环境设计
  collapsed:: true
	- 该功能库只为了好排查问题，外层对外API只根据输出环境区分。
	  collapsed:: true
		- ```kotlin
		  package com.wuba.unitylog
		  
		  interface IUnityLog {
		      fun debug(
		          tag: String , messageGenerator: IMessageGenerator? ,
		          owner: LogOwner? = null
		      )
		  
		      fun debug(
		          tag: String , error: Throwable? ,
		          owner: LogOwner? = null
		      )
		  
		      fun debug(
		          tag: String , messageGenerator: IMessageGenerator? , error: Throwable? ,
		          owner: LogOwner? = null
		      )
		  
		      fun release(
		          tag: String , messageGenerator: IMessageGenerator? ,
		          owner: LogOwner? = null
		      )
		  
		      fun release(
		          tag: String , error: Throwable? ,
		          owner: LogOwner? = null
		      )
		  
		      fun release(
		          tag: String , messageGenerator: IMessageGenerator? , error: Throwable? ,
		          owner: LogOwner? = null
		      )
		  
		      fun wlog(
		          tag: String , messageGenerator: IMessageGenerator? ,
		          owner: LogOwner? = null
		      )
		  
		      fun wlog(
		          tag: String , error: Throwable? ,
		          owner: LogOwner? = null
		      )
		  
		      fun wlog(
		          tag: String , messageGenerator: IMessageGenerator? , error: Throwable? ,
		          owner: LogOwner? = null
		      )
		  }
		  ```
	- 同城可用于展示 || 可上传的平台：AS控制台、Flipper(桌面插件)、WLog(上传服务器日志回捞)
	- ## Debug API(开发环境)
		- 1、该API release 包下不会输出log
		  collapsed:: true
			- ```kotlin
			      override fun debug(
			          tag: String ,
			          messageGenerator: IMessageGenerator? ,
			          error: Throwable? ,
			          owner: LogOwner?
			      ) {
			          if (UnityLogSDK.isPublishPackage) {
			              return
			          }
			          val messageBody = makeMessage(
			              tag , messageGenerator , LogLevel.DEBUG , owner
			          )
			          // to logcat
			          Log.i(getPrimaryKey() , messageBody , error)
			          // to flipper
			          UnityLogSDK.unityFlipper?.toFlipper(getPrimaryKey() , messageBody , error)
			      }
			  ```
		- 2、Log.i 将组装信息通过输出到AS控制台
		- 3、将信息对接回调Flipper插件
	- ## Release API(线上环境)
		- 正式包也会携带的Log日志，通常只是些标记性的内容。需要CR代码
		- 1、Log.e 将信息输出到控制台
		- 2、非发布包也对接Flipper插件
			- 根据发布标识判断，是否是发布包调用的API.
	- ## WLog(日志回捞环境)
		- 用于上传日志到服务器，日志回捞环境
		- 1、输出到日志回捞环境
		- 2、非发布包：
			- Log.i 输出到AS控制台
			- 对接Flipper插件
- # 功能三、日志携带的信息的编写
	- 日志输出时，携带基础环境、调用Log所在的类和方法
	- code:
		- 1、api接口:IUnityLog
		  collapsed:: true
			- ```kotlin
			  package com.wuba.unitylog
			  
			  interface IUnityLog {
			      fun debug(
			          tag: String , messageGenerator: IMessageGenerator? ,
			          owner: LogOwner? = null
			      )
			  
			      fun debug(
			          tag: String , error: Throwable? ,
			          owner: LogOwner? = null
			      )
			  
			      fun debug(
			          tag: String , messageGenerator: IMessageGenerator? , error: Throwable? ,
			          owner: LogOwner? = null
			      )
			  
			      fun release(
			          tag: String , messageGenerator: IMessageGenerator? ,
			          owner: LogOwner? = null
			      )
			  
			      fun release(
			          tag: String , error: Throwable? ,
			          owner: LogOwner? = null
			      )
			  
			      fun release(
			          tag: String , messageGenerator: IMessageGenerator? , error: Throwable? ,
			          owner: LogOwner? = null
			      )
			  
			      fun wlog(
			          tag: String , messageGenerator: IMessageGenerator? ,
			          owner: LogOwner? = null
			      )
			  
			      fun wlog(
			          tag: String , error: Throwable? ,
			          owner: LogOwner? = null
			      )
			  
			      fun wlog(
			          tag: String , messageGenerator: IMessageGenerator? , error: Throwable? ,
			          owner: LogOwner? = null
			      )
			  }
			  ```
		- 2、log基类:BaseUnityLog
		  collapsed:: true
			- 定义具体实现：如输出环境逻辑、字符串拼接、环境日志拼接
			- ```kotlin
			  package com.wuba.unitylog
			  
			  import android.util.Log
			  import com.wuba.unitylog.utils.LooperUtils
			  import com.wuba.unitylog.utils.ProcessUtils.getProcessName
			  
			  abstract class BaseUnityLog : IUnityLog {
			  
			      abstract fun getPrimaryKey(): String
			  
			      private fun makeMessage(
			          tag: String? ,
			          messageGenerator: IMessageGenerator? ,
			          logLevel: LogLevel ,
			          owner: LogOwner?
			      ): String {
			          val basicEnv = LogBasicEnv()
			          basicEnv.process = getProcessName(UnityLogSDK.applicationContext)
			          val isMainThread = "isMainThread=${LooperUtils.isMainThread}"
			          val threadId = "(id:${Thread.currentThread().id})"
			          basicEnv.threadInfo = "$isMainThread $threadId"
			          basicEnv.isForeground = UnityLogSDK.isForeground ?: true
			  
			          val builder = StringBuilder("[").append(tag ?: "").append("] ")
			              .append(messageGenerator?.getMessage() ?: "")
			              .append(" (level=").append(logLevel.value)
			              .append(", process=").append(basicEnv.process)
			              .append(", ").append(basicEnv.threadInfo)
			              .append(", isForeground=").append(basicEnv.isForeground)
			              .append(", method=").append(owner.toString())
			              .append(")")
			          return builder.toString()
			      }
			  
			      override fun debug(
			          tag: String ,
			          messageGenerator: IMessageGenerator? ,
			          owner: LogOwner?
			      ) {
			          debug(tag , messageGenerator , null , owner)
			      }
			  
			      override fun debug(
			          tag: String ,
			          error: Throwable? ,
			          owner: LogOwner?
			      ) {
			          debug(tag , null , error , owner)
			      }
			  
			      override fun debug(
			          tag: String ,
			          messageGenerator: IMessageGenerator? ,
			          error: Throwable? ,
			          owner: LogOwner?
			      ) {
			          if (UnityLogSDK.isPublishPackage) {
			              return
			          }
			          val messageBody = makeMessage(
			              tag , messageGenerator , LogLevel.DEBUG , owner
			          )
			          // to logcat
			          Log.i(getPrimaryKey() , messageBody , error)
			          // to flipper
			          UnityLogSDK.unityFlipper?.toFlipper(getPrimaryKey() , messageBody , error)
			      }
			  
			      override fun release(
			          tag: String ,
			          messageGenerator: IMessageGenerator? ,
			          owner: LogOwner?
			      ) {
			          release(tag , messageGenerator , null , owner)
			      }
			  
			      override fun release(
			          tag: String ,
			          error: Throwable? ,
			          owner: LogOwner?
			      ) {
			          release(tag , null , error , owner)
			      }
			  
			      override fun release(
			          tag: String ,
			          messageGenerator: IMessageGenerator? ,
			          error: Throwable? ,
			          owner: LogOwner?
			      ) {
			          val messageBody = makeMessage(
			              tag , messageGenerator , LogLevel.RELEASE , owner
			          )
			          // to logcat
			          Log.e(getPrimaryKey() , messageBody , error)
			          // to flipper if not publish package
			          if (!UnityLogSDK.isPublishPackage) {
			              UnityLogSDK.unityFlipper?.toFlipper(getPrimaryKey() , messageBody , error)
			          }
			      }
			  
			      override fun wlog(
			          tag: String ,
			          messageGenerator: IMessageGenerator? ,
			          owner: LogOwner?
			      ) {
			          wlog(tag , messageGenerator , null , owner)
			      }
			  
			      override fun wlog(
			          tag: String ,
			          error: Throwable? ,
			          owner: LogOwner?
			      ) {
			          wlog(tag , null , error , owner)
			      }
			  
			      override fun wlog(
			          tag: String ,
			          messageGenerator: IMessageGenerator? ,
			          error: Throwable? ,
			          owner: LogOwner?
			      ) {
			          val messageBody = makeMessage(
			              tag , messageGenerator , LogLevel.WLOG , owner
			          )
			  
			          // to wlog
			          UnityLogSDK.unityWLog?.toWLog(getPrimaryKey() , messageBody , error , owner)
			          // to logcat、flipper if not publish package
			          if (!UnityLogSDK.isPublishPackage) {
			              Log.i(getPrimaryKey() , messageBody , error)
			              UnityLogSDK.unityFlipper?.toFlipper(getPrimaryKey() , messageBody , error)
			          }
			      }
			  }
			  ```
			-
		- 3、IMessageGenerator：通过接口的方式获取RD输入的 message，避免字符串预创建
		  collapsed:: true
			- ```kotlin
			  interface IMessageGenerator {
			      fun getMessage(): String
			  }
			  
			  ```
		- 4、LogLevel 定义日志级别：分别在对应api调用，做log提示，通过哪个级别api打印的
		  collapsed:: true
			- ```kotlin
			  package com.wuba.unitylog
			  
			  internal enum class LogLevel(val value: String) {
			      DEBUG("debug") ,
			      RELEASE("release") ,
			      WLOG("wlog")
			  }
			  ```
			-
	- 优化点1；通过接口的方式获取RD输入的 message，避免字符串预创建
		- ```kotlin
		  interface IMessageGenerator {
		      fun getMessage(): String
		  }
		  
		  ```
- # 功能四、智能状态输出UnityLogSmart
  collapsed:: true
	- 智能日志内置在SDK中，如需借助Application，则在SDK初始化的时候，注册监听
	- ### 输出环境：
	  collapsed:: true
		- log.e 打印控制台
		- 通过IUnityFlipper接口 回传给Flipper插件
	- ## Android环境切换智能输出，与log基础环境赋值
	  collapsed:: true
		- ### 四大组件的切换，包括 Activity(又可以区分成 Native、RN、H5)，Service...
		- ### Activity 切换
		- ### Activity 的生命周期
		- ### 网络变化
		- ### 进程变化
		- ### 线程变化
	- ## 接入 App 可自定义：
	  collapsed:: true
		- ### 路由变化
		- ### cookie 变化
		- ### header 变化
		- ### 登陆状态变化
- # [[日志库常见问题]]