- ## ç®€å•ä»‹ç»
	- Javassist(java assist)ä¹Ÿæ˜¯ä¸€ç§ä¿®æ”¹å­—èŠ‚ç çš„å·¥å…·ï¼Œå®ƒä¸ä»…å¯ä»¥åƒASMä¸€æ ·åŸºäºå­—èŠ‚ç ä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥åœ¨æºä»£ç çº§é¢è¿›è¡Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥åƒå¹³æ—¶å†™ä»£ç ä¸€æ ·å»ä¿®æ”¹åŸjavaç±»ï¼Œè€Œä¸éœ€è¦ç†Ÿæ‚‰å­—èŠ‚ç è§„èŒƒï¼Œè¿™æ ·å°±å¤§å¤§å‡å°‘äº†æˆ‘ä»¬çš„å­¦ä¹ æˆæœ¬ã€‚
- ## ç¤ºä¾‹Demo
	- collapsed:: true
	  1. æ³¨å…¥ClassPath
		- Javassistå…è®¸æˆ‘ä»¬ç»•å¼€å­—èŠ‚ç ç›´æ¥ä¿®æ”¹æºç ï¼Œé‚£å®ƒå°±å¿…é¡»è¯»å–åŸæ¥çš„Classç±»æ–‡ä»¶ï¼Œè¿™æ ·å®ƒæ‰å¯ä»¥ç”Ÿæˆå‡ºæœ€ç»ˆçš„å­—èŠ‚ç ã€‚
		- ClassPoolç”¨äºå­˜å‚¨éœ€è¦å¤„ç†çš„ç±»æ–‡ä»¶åœ°å€æˆ–ClassLoaderï¼Œæˆ‘ä»¬éœ€è¦åœ¨transformå¤„ç†æ¯ä¸€ä¸ªinputæ—¶å°†è·¯å¾„æ³¨å…¥åˆ°ClassPoolä¸­ï¼Œå¦åˆ™ä¿®æ”¹æ—¶å¾ˆå¯èƒ½ä¼šæŠ¥é”™ NotFountExceptionã€‚
		- ```
		  abstract class BaseTransform(private val extension: BaseExtension) : Transform() {
		      protected val classPool: ClassPool = ClassPool.getDefault().apply {
		          // é‡ç‚¹ï¼ï¼ æ³¨å…¥android.jar
		          appendClassPath(extension.bootClasspath[0].absolutePath)
		      }
		      
		      @Throws(TransformException::class, InterruptedException::class, IOException::class)
		      final override fun transform(transformInvocation: TransformInvocation) {
		          ...
		          transformInvocation.inputs.forEach { input ->
		              input.jarInputs.forEach { jarInput ->
		                  // æ³¨å…¥jaråœ°å€
		                  classPool.appendClassPath(jarInput.file.absolutePath)
		                  ...
		              }
		              input.directoryInputs.forEach { directoryInput ->
		                  // æ³¨å…¥directoryåœ°å€
		                  classPool.appendClassPath(directoryInput.file.absolutePath)
		                  ...
		              }
		          }
		      }
		  }   
		  ```
	- 2ã€å¤„ç†å•ä¸ªç±»
	  collapsed:: true
		- Transformä¸­æ‰¾åˆ°å•ä¸ªéœ€è¦å¤„ç†çš„ç±»ï¼Œç„¶åé€šè¿‡classNameæ‰¾åˆ°å¯¹åº”ç±»è¿›è¡Œä¿®æ”¹
		- ```
		   /**
		       * å¤„ç†å®Œæˆåè¿˜æ˜¯é€šè¿‡ByteArrayå†™å›transformçš„è¾“å‡ºè·¯å¾„
		       */
		      override fun handleFileBytes(className: String): ByteArray {
		          val targetClass = classPool.get(className)
		          handleClass(targetClass)
		          
		          return targetClass.toBytecode()
		      }
		      
		      override fun handleClass(targetClass: CtClass) {
		          // æ˜¯å¦æ˜¯Activityçš„å­ç±»
		          if (!targetClass.subclassOf(classPool["android.app.Activity"])) {
		              return
		          }
		          val onCreateMethods = targetClass.getDeclaredMethods("onCreate")
		          for (onCreateMethod in onCreateMethods) {
		              // åˆ¤æ–­æ˜¯å¦æ˜¯onCreateç”Ÿå‘½å‘¨æœŸæ–¹æ³•
		              val params = onCreateMethod.parameterTypes
		              if (params.size != 1 || params[0] != classPool["android.os.Bundle"]) {
		                  continue
		              }
		              // çœŸæ­£çš„å¤„ç†
		              try {
		                  case2(targetClass, onCreateMethod)
		              } catch (e: CannotCompileException) {
		                  println("$name.handleClass CannotCompileException: $onCreateMethod")
		              }
		          }
		      }
		      
		      /**
		       * æ’å…¥åˆ°æ–¹æ³•åé¢
		       * æ³¨æ„
		       * 1. ä¸ç®¡å½“å‰ç±»æ˜¯å¦æ˜¯kotlinï¼Œåªèƒ½æ’å…¥javaä»£ç 
		       * 2. å¿…é¡»æ˜¯å¯ç”¨çš„è¡¨è¾¾å¼, ä¸èƒ½æ˜¯ç¼–è¯‘ä¸è¿‡çš„ä»£ç , æ¯”å¦‚å•ä¸ªæ‹¬å·
		       */
		      private fun case1(onCreateMethod: CtMethod) {
		          classPool.importPackage("android.widget.Toast")
		          onCreateMethod.insertAfter(
		              """
		                  showJavassistToast();
		                  Toast.makeText(this, JAVASSIST_SINGE_MSG, Toast.LENGTH_LONG).show();
		              """
		          )
		      }
		      
		      /**
		       * æ•´ä½“catch
		       * æ³¨æ„ï¼šaddCatch å¿…é¡»åœ¨æœ€åè¡¥å……return, å¦åˆ™æ³¨å…¥æŠ¥é”™ no basic block;
		       */
		      private fun case2(targetClass: CtClass, onCreateMethod: CtMethod) {
		          classPool.importPackage("android.util.Log")
		          onCreateMethod.addCatch(
		              """
		                  Log.e("${targetClass.name}", "ç©ºæŒ‡é’ˆäº†æˆ‘æ“¦:\n" + Log.getStackTraceString(${'$'}e));
		                  return;
		              """, classPool.get("java.lang.NullPointerException")
		          )
		      }
		  ```
	- ä»¥ä¸Šä»£ç å®ç°äº†å¯¹æ‰€æœ‰Activityçš„onCreateæ–¹æ³•æ·»åŠ try-catchã€‚
- ## å¯ä»¥ç”¨æ¥åšå“ªäº›å¤„ç†
	- æŒ‰ä¹‹å‰çš„äº†è§£ï¼ŒJavassistå­˜åœ¨ä¸€å®šçš„èƒ½åŠ›é™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´åå‘ASMã€‚ä¸è¿‡é€šè¿‡å¯¹Javassist-APIçš„ç®€å•æ¢³ç†ï¼Œå‘ç°å®ƒåŸºæœ¬ä¸Šä¹Ÿå¯ä»¥å®ç°æ‰€æœ‰çš„éœ€æ±‚ï¼š
	- ä¿®æ”¹è¯­å¥ï¼šCtMethod.instrument(CodeConverter())ï¼ŒCtMethod.instrument(ExprEditor)
	  æ’å…¥è¯­å¥ï¼šCtMethod.insertBefore, CtMethod.insertAfter, CtMethod.insertAt
	  æ•´ä½“æ›¿æ¢ï¼šCtMethod.setBody
	  æ•´ä½“catchï¼šCtMethod.addCatch
	  ä¿®æ”¹ä¿®é¥°ç¬¦ï¼šCtMethod/CtField/CtConstructor.setModifiers
	  â€¦
	  æ›´è¯¦ç»†çš„APIè¯·è§å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/jboss-javassist/javassist/wiki/Tutorial-2
- ## è¿˜èƒ½è¿è¡Œæ—¶ä¿®æ”¹ï¼Ÿ
  collapsed:: true
	- åœ¨çœ‹æ–‡æ¡£çš„æ—¶å€™å‘ç°äº†å½©è›‹ï¼Œjavassistç«Ÿç„¶è¿˜å¯ä»¥å®ç°è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹ä»£ç ï¼Œè€Œä¸”æœ‰ä¸¤ç§æ–¹å¼ï¼š
		- 1ã€CtClassåŒæ—¶æä¾›äº†Class<?> toClass(ClassLoader loader)ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ç›´æ¥å†™ä¸šåŠ¡ä»£ç æ—¶ä¿®æ”¹ä»»æ„ä»£ç ï¼Œç„¶åé€šè¿‡toClassæ„å»ºå‡ºä¿®æ”¹åå¯¹è±¡ã€‚ä¸è¿‡æ³¨æ„ï¼Œè¿™é‡Œä¸æ˜¯AOPç±»å‹çš„å¯¹åŸç±»æ–‡ä»¶åšä¿®æ”¹ï¼Œè€Œæ˜¯éšç”¨éšæ„å»ºï¼Œåªå¯¹å½“å‰æœ‰æ•ˆã€‚
		- 2ã€åŠ¨æ€ä»£ç† ProxyFactoryï¼Œçªç ´JDKæä¾›çš„Proxyå’ŒInvocationHandlerï¼Œå¯ä»¥å¤„ç†åŠ¨æ€ä»£ç†ç±»ã€‚ä½†æµ‹è¯•å‘ç°ç™½é«˜å…´ä¸€åœºğŸ˜‚ï¼Œå¯¹äºandroidå¦‚æœä½¿ç”¨ProxyFactoryçš„è¯ä¼šå´©æºƒï¼ŒåŸå› åœ¨äºAndroidä¿®æ”¹äº†JDKä»£ç ï¼ŒSecurityManager.getClassContextå¿…å®šè¿”å›nullå¯¼è‡´ç©ºæŒ‡é’ˆã€‚
		- ```
		  val proxyFactory = ProxyFactory().apply {
		      superclass = ProxyTest::class.java
		      setFilter { it.name == "test" }
		  }
		  val proxyClass = proxyFactory.createClass() // ç©ºæŒ‡é’ˆå´©æºƒ
		  (proxyClass as Proxy).setHandler { self, thisMethod, _, args ->
		      val result = thisMethod.invoke(self, args) as String
		      return@setHandler result + result
		  }
		  val proxyTest = proxyClass.newInstance() as ProxyTest
		  ```
- ## Javassistå¤„ç†åŸç†
  collapsed:: true
	- ![image.png](../assets/image_1684397704846_0.png)
- æ€»ç»“ä¸€ä¸‹
  Javassistä¸ASMç›¸æ¯”å­¦ä¹ æˆæœ¬æ¯”è¾ƒä½ï¼Œè€Œä¸”åŸºæœ¬å¯ä»¥æ»¡è¶³æ‰€æœ‰çš„éœ€æ±‚ï¼Œåç»­æœ‰Transformå¯ä»¥è€ƒè™‘ä¼˜å…ˆé‡‡ç”¨Javassistã€‚
- å¦å¤–Javassistå¯ä»¥è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹ç±»æ–‡ä»¶ï¼Œä¿®æ”¹ä¸‰æ–¹åº“bugæ—¶ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨Javassistå¤„ç†ã€‚